# 🍀 Coding Clover 핵심 기능 및 서버 아키텍처 상세 분석

이 문서는 **코딩 테스트 생성(AI)**, **소셜 로그인**, **SMTP/챗봇** 기능의 구현 원리와 서버 흐름을 상세하게 설명합니다. 특히 **"우리가 작성한 코드"**와 **"라이브러리(Spring Security 등)가 해주는 일"**을 명확히 구분하여 이해를 돕습니다.

---

## 🏗️ 서버 전체 아키텍처 (Server Architecture)

사용자가 버튼을 클릭했을 때, 서버 내부에서 데이터가 어떻게 이동하는지 보여주는 전체 지도입니다.

```plaintext
[브라우저 요청 (React)] 
      ↓
[필터 체인 (SecurityFilterChain)] : 👮‍♂️ 문지기 (보안 검사 & 로그인 처리)
      ↓
[컨트롤러 (Controller)] : 💁‍♂️ 안내 데스크 (요청을 받아서 적절한 서비스로 전달)
      ↓
[서비스 (Service)] : 👨‍💻 실무자 (비즈니스 로직 처리, 계산, 판단)
      ↓
[리포지토리 (Repository)] : 📦 창고지기 (DB 데이터 입출력)
      ↓
[데이터베이스 (DB)] : 🗄️ 데이터 저장소 (MySQL 등)
```

---

## 1. 🤖 AI 기반 코딩 테스트 생성 (Coding Test Generation)

관리자가 주제만 던져주면 AI가 알아서 문제, 정답 코드, 테스트 케이스까지 만들어주는 기능입니다.

### ❓ 이게 왜 필요한가요?
- 관리자가 일일이 문제를 출제하고, 테스트 케이스를 작성하는 시간을 획기적으로 줄여줍니다.
- AI가 생성한 초안을 에디터에서 바로 수정하고 실행해볼 수 있어 **검증된 문제**만 DB에 저장됩니다.

### 🚀 서버 흐름 상세 (Server Flow)

1.  **[Frontend] 사용자 입력 & 요청** (`CodingTestCreate.jsx`)
    - 관리자가 "주제: 스택, 난이도: 중급"을 입력하고 버튼을 누릅니다.
    - 프론트엔드는 이 정보를 바탕으로 **"구체적인 명령서(Prompt)"**를 만듭니다.
    - *명령서 예시*: "자바 코드로 스택 문제를 만들어줘. 단, `Scanner` 쓰지 말고 `main` 메서드 안에 입력값을 하드코딩해. 응답은 무조건 JSON 형식이어야 해."
    - `/ask` API로 이 명령서를 보냅니다.

2.  **[Backend - Controller] AI 통신** (`ChatController.java`)
    - **역할**: 단순히 프론트의 요청을 받아 LLM(ChatGPT 등)에게 전달하고, 응답을 받는 **"중계자"** 역할입니다.
    - 챗봇 기능을 위해 만들어둔 컨트롤러를 재사용합니다. (`SecurityConfig`에서 `/ask`는 누구나 접근 가능하게 열어둠)

3.  **[Frontend] 데이터 파싱 & 검증**
    - AI가 "제목, 설명, 코드, 정답"이 담긴 JSON을 보내줍니다.
    - 프론트엔드는 이 JSON을 해석(Parse)해서 화면의 입력상자에 자동으로 채워 넣습니다.
    - **중요**: 바로 저장하지 않습니다. 관리자가 눈으로 확인하고, "실행" 버튼을 눌러 코드가 잘 돌아가는지 확인하게 합니다.

4.  **[Backend - Controller & Repository] 최종 저장** (`ProblemController.java`)
    - 검증이 끝난 데이터를 받아 DB(`Problem` 테이블)에 저장합니다.
    - 이때 `baseCode`와 `expectedOutput`을 분리해서 저장하므로, 나중에 학생이 문제를 풀 때 채점 시스템이 정답과 학생의 출력을 비교할 수 있게 됩니다.

---

## 2. 🔐 소셜 로그인 (Social Login - OAuth2)

구글, 카카오, 네이버 아이디로 로그인하는 기능입니다. 여기서 **"DefaultOAuth2UserService"** 같은 낯선 이름이 등장합니다.

### ❓ DefaultOAuth2UserService가 뭔가요?
- 이건 **우리가 만든 파일이 아닙니다.** Spring Security 라이브러리에 이미 들어있는 **"기본 기능을 담당하는 클래스"**입니다.
- **비유**: "밀키트(Mealkit)" 같은 겁니다. 스프링이 "소셜 로그인 기본 로직은 다 짜놨으니까, 너는 **재료(회원 정보 저장 방식)**만 조금 수정해서 써"라고 주는 겁니다.
- 우리는 `SocialLoginService.java`라는 파일을 만들어서, 이 기본 클래스를 **상속(extends)** 받아 사용합니다. 즉, "기본 기능은 그대로 쓰되, **회원가입 부분만 내가 고쳐서 쓸게**"라고 선언하는 것입니다.

### 🚀 소셜 로그인 흐름도 (OAuth2 Flow)

이 과정은 **"우리 서버"**, **"사용자(브라우저)"**, **"소셜 플랫폼(구글/카카오)"** 세 곳이 핑퐁을 주고받으며 이루어집니다.

```plaintext
1. [User]  👉 "구글 로그인" 버튼 클릭
      ↓
2. [Spring Security]  👉 채로 낚아챔 (/oauth2/authorization/google)
      ↓ (리다이렉트)
3. [User Browser]  👉 구글 로그인 페이지로 이동 (accounts.google.com)
      ↓ (사용자가 아이디/비번 입력)
4. [Google Server]  👉 "이 사람 인증됨!" (인증 코드 발급)
      ↓ (다시 우리 서버로 돌아옴)
5. [Spring Security]  👉 인증 코드를 들고 구글 서버에 다시 가서 "액세스 토큰" 받아옴
      ↓ ("토큰 줄게, 유저 정보 내놔")
6. [Google Server]  👉 "옛다, 유저 정보(이메일, 이름, 프로필)" (JSON)
      ↓
7. [Spring Security]  👉 받아온 정보를 들고 `SocialLoginService` (우리가 만든 파일)를 호출
      ↓ ("야, 구글에서 이거 받아왔는데 처리 좀 해")
8. [SocialLoginService]  👉 이메일 확인 → (없으면) 회원가입 → (있으면) 로그인 처리
      ↓
9. [Spring Security]  👉 세션 생성 & 로그인 완료 (JSESSIONID 발급)
      ↓ (리다이렉트)
10.[User Browser]  👉 메인 페이지로 이동 (로그인 된 상태!)
```

### 🛠 상세 단계 설명

1.  **시작**: 사용자가 로그인 버튼을 누르면, 브라우저는 우리 서버의 특정 주소(`oauth2/authorization/google`)로 이동하려 합니다.
2.  **인터셉트**: 스프링 시큐리티 필터가 이 요청을 보고 "어? 구글 로그인이네?" 하고 알아챕니다. 그리고 브라우저에게 "구글 로그인 창으로 가라"고 명령(Redirect)합니다.
3.  **인증**: 사용자는 구글 사이트에서 로그인을 합니다. (우리 서버는 이때 아무것도 안 함)
4.  **콜백**: 로그인이 성공하면 구글은 사용자를 다시 우리 서버(`login/oauth2/code/google`)로 돌려보내면서, 손에 "인증 코드"를 쥐어줍니다.
5.  **토큰 교환**: 스프링 시큐리티는 이 "인증 코드"를 다시 구글에 보여주고, 진짜 열쇠인 "액세스 토큰"을 받아옵니다. (이 과정은 서버끼리 몰래 통신합니다)
6.  **정보 요청**: 이제 "액세스 토큰"을 가지고 구글에게 "유저 정보(이메일 등) 좀 줘"라고 요청합니다. (`DefaultOAuth2UserService`가 하는 일)
7.  **커스텀 처리**: 구글이 정보를 주면, 스프링 시큐리티는 **우리가 만든 `SocialLoginService.loadUser()` 메서드**를 호출하면서 그 정보를 넘겨줍니다.
8.  **DB 저장**: 우리는 여기서 이메일을 뽑아내서 DB에 저장하거나 업데이트합니다.
9.  **완료**: 모든 게끝나면 스프링 시큐리티가 세션을 굽고, 사용자를 메인 페이지로 이동시킵니다.

---

## 3. 📧 SMTP 이메일 & 🤖 챗봇 (SMTP & Chatbot)

### A. SMTP 이메일 인증

회원가입할 때 "이 이메일 진짜 네 거야?"라고 확인하는 과정입니다.

#### 🚀 핵심 포인트: "왜 DB가 아니라 세션(Session)을 쓸까?"
- 인증번호는 **잠깐 쓰고 버리는** 데이터입니다. 
- 이걸 굳이 DB에 저장했다가 지우는 건 낭비입니다.
- 그래서 **서버 메모리(Session)**에 잠깐 적어둡니다. "이 사람한테 123456 보냈음" 이라고요.

#### 🛠 흐름
1. **발송 요청**: 유저가 이메일을 입력하면 `MailController`는 난수(예: 482910)를 만들어서 메일로 쏘고, **세션에 `emailAuthNumber=482910`** 이라고 저장합니다.
2. **인증 확인**: 유저가 번호를 입력해서 보내면, 서버는 세션에 적어둔 번호랑 비교합니다. 맞으면 통과! 그리고 세션에서 지워버립니다(보안).

### B. AI 챗봇 (`ChatController.java`)

#### 🚀 핵심 구조
- **Thin Controller (얇은 컨트롤러)**: 복잡한 로직 없이, 외부 AI(LLM)와 대화하는 **창구** 역할만 합니다.
- **Flow**:
    - [유저 질문] -> [컨트롤러] -> [AI 모델] -> [답변] -> [컨트롤러] -> [유저 화면]
- **재사용성**: 이 컨트롤러는 단순히 "질문을 던지면 답을 준다"는 기능만 수행하므로, **코딩 테스트 생성 기능**에서도 "문제 만들어줘"라고 질문을 던지는 용도로 똑같이 사용합니다. (코드 재사용의 좋은 예시)

---

## 4. 📂 Users 폴더 파일 분석 (왜 이렇게 많을까요?)

회원 관리(Users) 폴더 안에 파일이 14개나 됩니다. "도대체 뭐가 이렇게 많아?" 하실 수 있는데, 역할별로 깔끔하게 정리해 드리겠습니다.

### 📝 핵심 (Core) - "진짜 주인공들"
| 파일명 | 역할 | 비유 |
| :--- | :--- | :--- |
| **`Users.java`** | DB 테이블 모양 정의 (엔티티) | "회원가입 신청서 양식" |
| **`UsersRepository.java`** | DB에 실제로 저장/조회하는 인터페이스 | "서류 보관함 관리자" |
| **`UsersService.java`** | 회원가입, 정보수정 등 핵심 업무 처리 | "회원 관리 팀장" (실무 담당) |
| **`UsersController.java`** | 웹 요청(로그인, 가입 등)을 받아 서비스로 연결 | "민원 접수 창구 직원" |

### 🔐 보안 & 로그인 (Security) - "문지기 팀"
| 파일명 | 역할 | 설명 |
| :--- | :--- | :--- |
| **`UsersSecurityService.java`** | 일반 로그인 시 DB에서 비번 확인 | "신분증 대조 담당자" (스프링 시큐리티용) |
| **`SocialLoginService.java`** | 소셜 로그인(구글/카카오) 처리 | "여권(외국 신분증) 확인 담당자" |
| **`ApiLoginFilter.java`** | JSON 요청을 가로채서 로그인 시도 | "입구 컷 담당" (올바른 형식인지 검사) |
| **`ApiLoginSuccess.java`** | 로그인 **성공** 시 할 일 (JSON 응답) | "어서오세요~ (환영 메시지 전송)" |
| **`ApiLoginFail.java`** | 로그인 **실패** 시 할 일 (에러 응답) | "돌아가세요! (거절 메시지 전송)" |

### 📦 데이터 포장 (DTO/Enum) - "택배 상자와 라벨"
| 파일명 | 역할 | 설명 |
| :--- | :--- | :--- |
| **`UsersRole.java`** | 권한 목록 (STUDENT, INSTRUCTOR, ADMIN) | "직급표" (사원, 대리, 부장...) |
| **`UsersStatus.java`** | 활동 상태 (ACTIVE, BANNED) | "근태 현황판" (재직중, 정직...) |
| **`InstructorDTO.java`** | 강사 정보만 추려서 보여줄 때 사용 | "강사님용 명함" |
| **`StudentDTO.java`** | 학생 정보만 추려서 보여줄 때 사용 | "학생용 학생증" |
| **`UsersFindRequest.java`** | 아이디/비번 찾기 요청 데이터 담는 그릇 | "분실물 찾기 신청서" |

### 💡 요약
- **Controller/Service/Repository**: 일하는 3대장 (필수)
- **Security 관련 파일들**: 로그인/보안을 위해 스프링 시큐리티가 요구하는 부속품들 (필수)
- **DTO/Enum**: 데이터를 깔끔하게 정리하고 에러를 줄이기 위한 도구들
